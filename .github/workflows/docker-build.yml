name: Build and Push Docker Image

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: remote-browser

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate build version
        id: version
        run: |
          BUILD_VERSION="${GITHUB_RUN_NUMBER}"
          echo "version=${BUILD_VERSION}" >> $GITHUB_OUTPUT
          echo "Build version: ${BUILD_VERSION}"

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ steps.version.outputs.version }}
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Build Docker image (for testing)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          tags: test-remote-browser:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          pip install -r tests/requirements.txt

      - name: Start test container
        run: |
          echo "Starting container with VNC password..."
          docker run -d --name test-remote-browser \
            -p 9222:9222 \
            -p 5900:5900 \
            -e VNC_PASSWORD=testpass123 \
            test-remote-browser:latest

      - name: Run port tests
        run: |
          pytest tests/test_ports.py -v
        continue-on-error: false

      - name: Show container logs on failure
        if: failure()
        run: |
          docker logs test-remote-browser

      - name: Cleanup test container
        if: always()
        run: |
          docker stop test-remote-browser || true
          docker rm test-remote-browser || true

      - name: Build and push Docker image (multi-platform)
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update Docker Hub README
        if: github.event_name != 'pull_request'
        run: |
          python3 << 'EOF'
          import json
          import requests
          import os
          import time
          
          def request_with_retries(method, url, *, max_attempts=6, timeout=15, retry_statuses=None, **kwargs):
              """
              Retry helper for flaky upstream endpoints.
              Retries on network errors and specific HTTP statuses (e.g. 429/5xx).
              """
              if retry_statuses is None:
                  retry_statuses = {429, 500, 502, 503, 504}
          
              last_exc = None
              for attempt in range(1, max_attempts + 1):
                  try:
                      resp = requests.request(method, url, timeout=timeout, **kwargs)
                      if resp.status_code in retry_statuses:
                          raise RuntimeError(f"retryable_status={resp.status_code} body={resp.text[:500]}")
                      return resp
                  except Exception as e:
                      last_exc = e
                      if attempt == max_attempts:
                          raise
                      sleep_s = min(30, 2 ** attempt)
                      print(f"WARN: request failed ({attempt}/{max_attempts}) {method} {url}: {e}. Retrying in {sleep_s}s...")
                      time.sleep(sleep_s)
          
              raise last_exc  # pragma: no cover
          
          # Read README.md
          with open('README.md', 'r') as f:
              readme_content = f.read()
          
          # Get JWT token from Docker Hub
          username = os.environ['DOCKERHUB_USERNAME']
          password = os.environ['DOCKERHUB_TOKEN']
          image_name = os.environ['IMAGE_NAME']
          
          # Login to get JWT token
          login_url = "https://hub.docker.com/v2/users/login/"
          try:
              login_response = request_with_retries(
                  "POST",
                  login_url,
                  json={"username": username, "password": password},
              )
          except Exception as e:
              # Docker Hub occasionally returns transient 5xx here; don't fail the whole build on that.
              print(f"WARN: Docker Hub login failed after retries: {e}")
              print("WARN: Skipping README sync due to Docker Hub login instability.")
              raise SystemExit(0)
          
          if login_response.status_code != 200:
              # Non-retryable failure (e.g. 401/403). This should fail the workflow so secrets can be fixed.
              print(f"✗ Failed to authenticate with Docker Hub: {login_response.status_code}")
              print(f"Response: {login_response.text}")
              raise SystemExit(1)
          
          jwt_token = login_response.json().get("token")
          if not jwt_token:
              print("✗ Failed to get JWT token from Docker Hub")
              raise SystemExit(1)
          
          # Update Docker Hub repository description using JWT token
          url = f"https://hub.docker.com/v2/repositories/{username}/{image_name}/"
          headers = {
              "Content-Type": "application/json",
              "Authorization": f"JWT {jwt_token}"
          }
          data = {"full_description": readme_content}
          
          try:
              response = request_with_retries("PATCH", url, headers=headers, json=data)
          except Exception as e:
              print(f"WARN: Docker Hub README update failed after retries: {e}")
              print("WARN: Skipping README sync failure (image already pushed).")
              raise SystemExit(0)
          
          if response.status_code in [200, 201]:
              print("✓ Docker Hub README updated successfully")
          else:
              print(f"✗ Failed to update Docker Hub README: {response.status_code}")
              print(f"Response: {response.text}")
              # If auth/permission issue, fail; otherwise don't block the image.
              if response.status_code in (401, 403):
                  raise SystemExit(1)
              raise SystemExit(0)
          EOF
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}

